name: Release Specification2

on:
  # Trigger bij nieuwe release
  release:
    types: [published]
  
  # Handmatig triggeren
  workflow_dispatch:
    inputs:
      version:
        description: 'Version folder to release (e.g., v6)'
        required: true
        default: 'v6'

jobs:
  deploy-to-website:
    runs-on: ubuntu-latest
    steps:
      # Stap 1: Genereer een installatie token via de GitHub App
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: R4Architecture
#          owner: open-education-api
          repositories: |
            site
            r4architecture.github.io
#            specification
#            open-education-api.github.io

      # Stap 2: Checkout specification repo (huidige repo)
      - name: Checkout specification repo
        uses: actions/checkout@v4
        with:
          path: site

      # Stap 3: Checkout website repo met het gegenereerde token
      - name: Checkout website repo
        uses: actions/checkout@v4
        with:
          repository: r4architecture/r4architecture.github.io
#          repository: open-education-api/open-education-api.github.io
          token: ${{ steps.app-token.outputs.token }}
          path: website

      # Stap 4: Bepaal welke versie we releasen
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            # Extract version from release tag (e.g., v6.0.0 -> v6)
            VERSION=$(echo "${{ github.event.release.tag_name }}" | grep -oE 'v[0-9]+')
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Releasing version: $VERSION"

      # Stap 5: Kopieer specificatie naar website repo
      - name: Copy specification to website
        run: |
          VERSION=${{ steps.version.outputs.version }}
          # SOURCE_DIR="specification/$VERSION"
          # Toekomstig wanneer je /source gebruikt:
          SOURCE_DIR="site/source"
          
          if [ ! -d "$SOURCE_DIR" ]; then
            echo "‚ùå Error: Source directory $SOURCE_DIR does not exist"
            exit 1
          fi
          
          echo "üìÇ Copying from $SOURCE_DIR to website/$VERSION"
          
          # Verwijder oude versie indien aanwezig
          rm -rf "website/$VERSION"
          
          # Kopieer nieuwe versie
          cp -r "$SOURCE_DIR" "website/$VERSION"
          
          echo "‚úÖ Copy completed"

      # Stap 6: Commit en push naar website repo
      - name: Commit and push to website
        working-directory: website
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          git config user.name "ooapi-spec-deployer[bot]"
          git config user.email "ooapi-spec-deployer[bot]@users.noreply.github.com"
          
          git add .
          
          # Check of er changes zijn
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
            exit 0
          fi
          
          git commit -m "üöÄ Release ${{ steps.version.outputs.version }} from specification repo

          Triggered by: ${{ github.event_name }}
          Source commit: ${{ github.sha }}
          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git push
          
          echo "‚úÖ Successfully pushed to open-education-api.github.io"
